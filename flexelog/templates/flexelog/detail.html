{% extends "flexelog/base.html" %}

{% block title %}Fl'og {{ entry.attrs.Subject }}{% endblock title %}
{% block more_head_links %}
{% include "flexelog/include/editor_tui.html" %}
{% endblock more_head_links %}

{% block body %}
<form name="form1" method="GET" action="{% url 'flexelog:detail' logbook.name entry.id %}">
  {% csrf_token %}
  <input type="hidden" name="page_type" value="{{ page_type }}" />
  <table class="frame" cellpadding="0" cellspacing="0">
  {% include "flexelog/include/lb_tabs.html" %}
  <table class="listframe" width="100%" cellspacing="0" cellpadding="0">
    <tr>
    <td class="attribhead">
        Message ID:&nbsp;<b>{{ entry.id }}</b>
        &nbsp;&nbsp;&nbsp;&nbsp;Entry time:&nbsp;<b>{{ entry.date }}</b>
    </td>
    </tr>
    <tr>
    <td>
    <table width="100%" cellpadding="0" cellspacing="0">
        {% for attr, val in entry.attrs.items %}
        <tr>
            <td class="attribname" nowrap>{{ attr }}:</td>
            <td class="attribvalue">{{ val }}</td>
        </tr>
        {% endfor %}
    </table>
    </td>
    </tr>

    {# EDITOR/VIEWER #}
    <tr>
    <td class="messageframe">
        <textarea hidden name="editor_markdown" id="editor_markdown">
{{ entry.text }}
<p>&nbsp;</p>
        </textarea>
        <div id="viewer"></div>
    </td>
    </tr>

  </table>
</table>
</form>

<script language="javascript" type="text/javascript">
function latexPlugin() {
    const toHTMLRenderers = {
        latex(node) {
            const html = katex.renderToString(node.literal);

            return [
                { type: 'openTag', tagName: 'div', outerNewLine: true },
                { type: 'html', content: html },
                { type: 'closeTag', tagName: 'div', outerNewLine: true }
            ];
        }
    }
    return { toHTMLRenderers };
}
    
const { Editor } = toastui;
const { chart, codeSyntaxHighlight, colorSyntax, tableMergedCell } = Editor.plugin;
const editor = toastui.Editor.factory({
    el: document.querySelector('#viewer'),
    viewer: true,
    initialValue: '',
    usageStatistics: false,
    mathSupport: true,
    plugins: [[chart, {maxWidth:750, maxHeight:500}], [codeSyntaxHighlight, {highlighter: Prism}], colorSyntax, tableMergedCell, latexPlugin],
});

function body_onload() {            
    var text = document.getElementById("editor_markdown").value;
    editor.setMarkdown(text);
    return true;
}
</script>
{% endblock body %}